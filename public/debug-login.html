<!DOCTYPE html>
<html>
<head>
    <title>Debug Login Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #ccc; }
        .success { border-color: green; background: #f0fff0; }
        .error { border-color: red; background: #fff0f0; }
        .pending { border-color: orange; background: #fff8f0; }
        button { background: #0070f3; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Debug Admin Login Step by Step</h1>
    
    <button onclick="runDebugTest()">Run Debug Test</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <div id="results"></div>
    
    <script>
        let stepCounter = 0;
        
        function addStep(message, status = 'pending') {
            stepCounter++;
            const div = document.createElement('div');
            div.className = `step ${status}`;
            div.innerHTML = `<strong>Step ${stepCounter}:</strong> ${message}`;
            div.id = `step-${stepCounter}`;
            document.getElementById('results').appendChild(div);
            return stepCounter;
        }
        
        function updateStep(stepId, message, status) {
            const div = document.getElementById(`step-${stepId}`);
            if (div) {
                div.className = `step ${status}`;
                div.innerHTML = `<strong>Step ${stepId}:</strong> ${message}`;
            }
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            stepCounter = 0;
        }
        
        async function runDebugTest() {
            clearResults();
            
            try {
                // Step 1: Test basic fetch
                const step1 = addStep('Testing basic connectivity...', 'pending');
                const pingResponse = await fetch('/api/me');
                updateStep(step1, `Basic connectivity: ${pingResponse.status} ${pingResponse.statusText}`, 'success');
                
                // Step 2: Test login API call
                const step2 = addStep('Calling login API...', 'pending');
                const loginStart = Date.now();
                
                const loginResponse = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'admin@equipgg.net',
                        password: 'admin123'
                    }),
                    credentials: 'include'
                });
                
                const loginDuration = Date.now() - loginStart;
                
                if (!loginResponse.ok) {
                    const errorData = await loginResponse.json();
                    updateStep(step2, `Login API failed: ${loginResponse.status} - ${errorData.error}`, 'error');
                    return;
                }
                
                updateStep(step2, `Login API successful (${loginDuration}ms): ${loginResponse.status}`, 'success');
                
                // Step 3: Parse response
                const step3 = addStep('Parsing login response...', 'pending');
                const loginData = await loginResponse.json();
                updateStep(step3, `Response parsed - Has session: ${!!loginData.session}, Has user: ${!!loginData.user}`, 'success');
                
                // Step 4: Check session details
                const step4 = addStep('Checking session details...', 'pending');
                if (loginData.session) {
                    updateStep(step4, `Session: Token=${!!loginData.session.access_token}, Expires=${loginData.session.expires_at}`, 'success');
                } else {
                    updateStep(step4, 'No session in response!', 'error');
                    return;
                }
                
                // Step 5: Check user details  
                const step5 = addStep('Checking user details...', 'pending');
                if (loginData.user) {
                    updateStep(step5, `User: ${loginData.user.email}, Role: ${loginData.user.role}, ID: ${loginData.user.id}`, 'success');
                } else {
                    updateStep(step5, 'No user in response!', 'error');
                    return;
                }
                
                // Step 6: Test session verification
                const step6 = addStep('Verifying session with /api/me...', 'pending');
                const meResponse = await fetch('/api/me', { credentials: 'include' });
                const meData = await meResponse.json();
                
                if (meResponse.ok && meData.user) {
                    updateStep(step6, `Session verified: ${meData.user.email} (${meData.user.role})`, 'success');
                } else {
                    updateStep(step6, `Session verification failed: ${meResponse.status}`, 'error');
                }
                
                // Step 7: Test dashboard access
                const step7 = addStep('Testing dashboard access...', 'pending');
                const dashResponse = await fetch('/dashboard', { credentials: 'include' });
                updateStep(step7, `Dashboard access: ${dashResponse.status} ${dashResponse.statusText}`, 
                          dashResponse.ok ? 'success' : 'error');
                
                // Step 8: Show final result
                const step8 = addStep('Login test completed successfully! ðŸŽ‰', 'success');
                
            } catch (error) {
                addStep(`Test failed with error: ${error.message}`, 'error');
                console.error('Debug test error:', error);
            }
        }
    </script>
</body>
</html>